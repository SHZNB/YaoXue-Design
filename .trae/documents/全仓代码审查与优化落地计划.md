## 目标与范围
- 全面审查与优化：前端 React/Vite、后端 Express、Supabase 认证、构建与测试、配置与安全。
- 重点修复：注册时的 “email rate limit exceeded” 问题、认证与安全体系、性能与可维护性。

## 现状与问题概览
- 前端认证逻辑集中在 [Auth.tsx](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/pages/Auth.tsx)，已做强密码、二次确认与错误提示，但仅前端校验。
- 会话与档案查询在 [authStore.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/store/authStore.ts)，存在重复查询与可缓存空间。
- 服务端仅有占位认证路由 [auth.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/routes/auth.ts)，未启用速率限制、CSRF、输入校验、Helmet 安全头。[app.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/app.ts)
- Dev 代理日志过多，可能泄露请求信息。[vite.config.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/vite.config.ts)
- 测试已覆盖 Auth 前端行为 [Auth.test.tsx](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/pages/__tests__/Auth.test.tsx)，服务端与安全用例缺失。

## 核心修复方案
### 修复注册频率限制（email rate limit exceeded）
- 在前端添加注册/重发邮件的退避与冷却（按钮倒计时、节流 60s），并捕获错误展示友好提示。
- 引入 CAPTCHA（Turnstile/hCaptcha）在注册与重发邮件前校验，降低被滥用概率。
- 服务端加速率限制（express-rate-limit）与黑名单策略，保护 /api 入口。[app.ts](file:///e:/AAA%20My%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/app.ts)
- 在 Supabase 配置自有 SMTP（如 SendGrid）以提升配额与稳定性（必要时）。

### 认证与安全加固
- 服务端启用 Helmet（HSTS、CSP、X-Frame-Options、XSS-Protection）与严格 CORS 白名单。[app.ts](file:///e:/AAA%20My%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/app.ts)
- 补充输入校验与统一错误处理（返回模糊化信息），记录审计日志。
- 实现后端鉴权中间件（校验 Supabase JWT，角色授权），补齐占位路由。[auth.ts](file:///e:/AAA%20My%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/routes/auth.ts)
- CSRF 防护（SameSite=Strict + CSRF Token 对需要 Cookie 的接口）。

### 性能优化
- 降低 body 限制（10MB→1–2MB），开启 compression 与限流，减少 DoS 风险。[app.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/app.ts)
- 缓存或合并 profile 查询，减少重复请求。[authStore.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/store/authStore.ts)
- 前端路由懒加载与组件 memo，打包体积巡检与 tree-shaking。
- Dev 代理日志仅在错误时输出、生产关闭。[vite.config.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/vite.config.ts)

### 代码质量与重构
- 启用 TypeScript 严格模式、ESLint 规则加强，统一命名与模块边界。[tsconfig.json](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/tsconfig.json), [eslint.config.js](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/eslint.config.js)
- 提取认证与会话逻辑到独立 hooks/service，减少页面耦合。[supabase.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/lib/supabase.ts)
- 增加错误边界与统一的 Toast/Alert 组件，优化错误展示位置与可用性。

### 测试与验证
- 前端：补全路由保护、懒加载、错误边界、强密码/确认密码、CAPTCHA 流程用例。
- 后端：速率限制、Helmet/CORS、生僻输入与异常路径、JWT 校验与授权用例。
- 集成：注册→验证→登录→刷新 Token→登出全链路，含高频注册压力测试与并发行为。

### 文档更新
- 更新认证与安全文档（新增速率限制、CSP、安全头）；部署与回滚步骤；测试覆盖说明。
- 在现有文档 [authentication_system.md](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/docs/authentication_system.md) 中补充邮件限流、CAPTCHA、后端鉴权章节。

## 实施步骤（执行顺序）
1. 后端接入 Helmet、CORS 白名单、express-rate-limit、compression；统一错误处理中间件。[app.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/app.ts)
2. 实现 JWT 校验与角色授权中间件，补齐 auth 路由逻辑。[auth.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/api/routes/auth.ts)
3. 前端注册引入 CAPTCHA 与按钮冷却、退避策略；统一错误提示组件。[Auth.tsx](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/pages/Auth.tsx)
4. 优化会话与 profile 查询缓存；路由懒加载与打包巡检。
5. 加强 TS 严格模式、ESLint 规则；重构认证逻辑为 hooks/service。
6. 编写后端与前端单元/集成测试与压力测试；接入 CI。
7. 更新文档与部署到 Vercel；灰度验证并回滚预案。

## 验收标准
- 注册在高频场景下不再触发限流（或有明确冷却与提示），错误信息统一、友好。
- 认证与授权在服务端落地，安全头与速率限制生效，CORS 与 CSRF 得到控制。
- 构建产物与接口 P99 延迟达标（≤200ms），测试全部通过，日志与监控可观测。

如确认计划，我将开始按上述步骤实施并提交详细问题清单、修复方案、性能数据与测试结果。