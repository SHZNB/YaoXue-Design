## 问题分析与修复方案（注销报错）
- 现象：浏览器日志显示 net::ERR_ABORTED 调用 Supabase 全局注销 `auth/v1/logout?scope=global`。
- 常见原因：
  - 页面在注销发起后立刻导航/刷新，浏览器主动取消请求（最常见）。
  - 多次并发调用 signOut 造成前一次请求被后续导航取消。
  - 本地预览跨源网络波动或拦截（但 Supabase CORS 默认允许）。
- 修复建议（代码层）：
  - 在 store 的 signOut 增加防抖与状态守卫，避免并发调用：见 [authStore.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/store/authStore.ts#L70-L74)。
  - 优先使用 `supabase.auth.signOut({ scope: 'local' })`，仅在“全部设备退出”时提供 UI 触发 `scope: 'global'`。
  - 捕获并忽略 AbortError：`if (err.name === 'AbortError') return;`，避免用户感知为失败。
  - 在路由跳转前等待注销 Promise 完成或采用 `Promise.race([signOut, timeout])` 控制。
  - 继续保留 `hasSupabaseEnv` 守卫：已在 [supabase.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/lib/supabase.ts) 与 [authStore.ts](file:///e:/AAA%20My%20New%20Project/Trying%20to%20make%20a%20YaoXue%20Design/src/store/authStore.ts) 应用。
- 验证：在本地与线上点击注销时不再抛浏览器错误，UI正常返回登录页。

## 单邮箱多角色账号体系设计
### 身份模型
- 核心：Supabase `auth.users` 仍保持“邮箱唯一的账号”，在业务层引入“角色实例”。
- 新表：
  - `roles`：固定枚举（student/teacher/parent）。
  - `user_roles`：一对多映射（user_id + role 唯一），含状态（active/suspended）、可选学段、机构信息等。
  - `profiles`：保留通用信息（full_name/avatar），若需角色差异则扩展 `role_profiles`（user_role_id -> 角色专属字段）。
  - `audit_logs`：审计日志（actor_user_id、actor_role、action、resource、delta、ip、ua、at）。
- 触发器：注册后根据 `raw_user_meta_data.role` 自动插入首个 `user_roles`；若同邮箱再次选择新角色，仅新增 `user_roles` 并避免重复邮箱检查造成冲突。

### 权限与隔离（RLS）
- 基本策略：所有业务数据表都以 `user_role_id` 作为归属维度。
- RLS 示例：
  - 仅允许 `auth.uid()` 通过关联的 `user_roles` 访问匹配 `user_role_id` 的行。
  - 教师端对班级/作业表有基于机构与班级绑定的更高权限；家长端仅可访问与其关联学生的只读数据。
- 管理操作走服务端（Edge Functions/服务器）并以管理员角色执行，用户态禁止越权字段写入。

### 角色切换机制
- 前端会话中存储 `current_role_id`（Memory/LocalStorage），后端基于此返回视图与数据。
- 切换流程：
  - 查询 `user_roles` 列表 → 用户选择 → 更新 `current_role_id` → 重新加载对应角色的数据域。
  - 若角色处于 `suspended`，UI 禁止切换并提示原因。

### 后台管理界面
- 能力：同邮箱下不同角色的独立管理（状态、权限、数据域查看/冻结、重置绑定）。
- 结构：
  - 用户视图：按邮箱聚合，展开显示各 `user_roles`。
  - 角色视图：按角色筛选，支持批量操作。
  - 审计视图：可检索相同邮箱的跨角色操作轨迹。
- 接口：管理员 API（RBAC）+ RLS 绕过通过服务端执行（安全审核与审计日志写入）。

### 注册流程优化
- Signup 第一步选择角色（student/teacher/parent）与必要上下文（学校/班级/孩子关联）。
- 若邮箱已存在：跳过账号创建，仅新增 `user_roles` 并提示“该邮箱已存在账号，已为你绑定新的角色”。
- 邮件验证后落地到站点，默认选中刚创建的 `user_roles`。
- 防冲突：表级唯一约束 `(user_id, role)` + 并发写的事务处理与重试。

### 审计日志与合规
- 审计内容：角色切换、资源访问、敏感字段变更、管理操作、登录/注销、失败原因。
- 合规：
  - 最小权限原则（RLS + RBAC）。
  - 数据分域（按角色/班级/机构隔离）。
  - 可删除权与数据导出（家长端/学生端合规需求）。
  - 留存周期与脱敏（PII 最小化，日志中对邮箱做部分掩码）。

## 虚拟仿真实验平台设计
### 技术选型
- 引擎：
  - Web 方案优先：Babylon.js 或 Three.js + Cannon.js/Ammo.js（物理）。
  - 如需更复杂画质/管线：Unity WebGL（构建到 Web），或 Unreal Pixel Streaming（成本与带宽更高）。
- 架构：前端实验容器 + 实验引擎模块（插件化）+ 实时协同服务（WebSocket/WebRTC）+ 数据采集与分析服务。

### 关键能力
- 3D 交互：拖拽、组装、参数调节、标尺/网格对齐、快照与回放。
- 物理模拟：
  - 力学：重力、摩擦、弹性碰撞、刚体约束。
  - 光学：光线追踪近似、折射/反射、光源参数化。
  - 化学：更适合基于过程规则与状态机的近似模拟（与安全限制）。
- 数据采集：事件与状态时序采集，生成实验报告（PDF/JSON），支持教师端评分与指标权重。
- 多人协同：
  - 房间/会话模型，角色权限（主持/观察/学生）。
  - 状态同步（CRDT/锁步/服务器权威），语音与注释。
- 教师端：实验模板管理、参数预设、作业下发、过程监控（时序事件+屏幕快照）、评分与反馈。
- 可扩展：实验以插件与 JSON 模板描述，热加载与版本化管理。

### 性能与兼容
- 优化：对象池、LOD、GPU Instancing、纹理压缩（Basis/KTX2）、WebGL2 优先，移动端降级策略。
- 兼容：主流浏览器与移动设备，回退到 2D/低模版本；检测设备能力自适配。

### 测试与验证
- 功能测试：交互、物理一致性、多人同步、报告生成。
- 压测：房间并发/同步频率，P95/P99 延迟与丢包容忍。
- 兼容性：浏览器矩阵、移动机型、弱网/高延迟场景。

## 交付与实施步骤
1) 注销错误修复：更新 signOut 流程（防抖、scope 控制、AbortError 兜底），并验证。
2) 数据建模与迁移：新增 `roles/user_roles/role_profiles/audit_logs`，唯一约束与索引，触发器与初始 RLS 政策。
3) 前端改造：注册选择角色、角色切换 UI、基于 `current_role_id` 的数据域加载；管理后台界面（基础表格/筛选/审计视图）。
4) 服务与策略：RBAC、服务端管理员 API、审计流水与告警。
5) 虚拟实验 MVP：选定 2-3 个实验（力学/光学），实现 3D 交互、物理、数据采集与报告；教师端预设与监控。
6) 扩展与优化：多人协同房间、性能优化、实验模板系统、测试矩阵完善。

如确认方案，我将开始落地：先修复注销错误与账号模型迁移，然后搭建管理界面与首批虚拟实验（web 方案优先）。